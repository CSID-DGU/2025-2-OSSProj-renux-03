using FluentValidation;
using AutoMapper;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;

using RenuxServer.DbContexts;
using RenuxServer.Dtos.AuthDtos;
using RenuxServer.Models;
using System.Security.Claims;
using System.IdentityModel.Tokens.Jwt;

namespace RenuxServer.Apis.Auth;

static public class AuthenticationApis
{
    static public void AddAuthApis(this WebApplication application)
    {
        var app = application.MapGroup("/auth");

        app.MapPost("/signup",
            async (ServerDbContext db, SignupUserDto signup, IValidator<SignupUserDto> validator,
            IMapper mapper) =>
        {
            var results = validator.Validate(signup);

            if (!results.IsValid) return Results.ValidationProblem(results.ToDictionary());

            if (await db.Users.AnyAsync(p => p.UserId == signup.UserId)) return Results.Conflict("중복된 id");
            
            User user = mapper.Map<User>(signup);

            user.HashPassword = BCrypt.Net.BCrypt.HashPassword(signup.Password);

            db.Users.Add(user);

            await db.SaveChangesAsync();

            return Results.Ok(new { Message = "OK" });
        });

        app.MapPost("/signin", async (ServerDbContext db, SigninUserDto signin, IValidator<SigninUserDto> validator,
            IConfiguration config, HttpContext context) =>
        {
            var results = validator.Validate(signin);

            if (!results.IsValid) return Results.Unauthorized();

            User? user = await db.Users.FirstOrDefaultAsync(u => u.UserId == signin.UserId);

            if (user == null || !BCrypt.Net.BCrypt.Verify(signin.Password, user.HashPassword)) return Results.Unauthorized();

            var jwt = config.GetSection("Jwt");

            SigningCredentials credential = new(new SymmetricSecurityKey(Convert.FromBase64String(jwt["Key"]!)),
                SecurityAlgorithms.HmacSha512);

            Claim[] claims_ =
            {
                new Claim(JwtRegisteredClaimNames.Sub, user.Id.ToString()),
                new Claim(JwtRegisteredClaimNames.Name, user.Username)
            };

            JwtSecurityToken token = new(
                issuer: jwt["Issuer"],
                audience: jwt["Audience"],
                claims: claims_,
                expires: DateTime.Now.AddMinutes(60),
                signingCredentials: credential);

            CookieOptions copt = new()
            {
                HttpOnly = true,
                Secure = true,
                Expires = DateTime.Now.AddMinutes(60)
            };

            string tokenString = new JwtSecurityTokenHandler().WriteToken(token);
            context.Response.Cookies.Append("renux-server-token", tokenString, copt);

            return Results.Ok(new { Message = "OK" });
        });

        app.MapGet("/signout", (HttpContext context) =>
        {
            context.Response.Cookies.Delete("renux-server-token");

            return Results.Ok(new { Message = "Ok" });
        }).RequireAuthorization();

    }
}
